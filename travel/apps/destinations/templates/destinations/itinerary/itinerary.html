{% extends 'destinations/base.html' %}
{% load static i18n %}
{% block title %}{% trans 'Create Itinerary' %}{% endblock %}

{%block css%}
{{ block.super }}
{{ form.media.css }}
<link href="{% static "inspinia/js/plugins/select2/select2.min.css" %}" rel="stylesheet">
<link href="{% static "inspinia/js/plugins/dataTables/datatables.min.css" %}" rel="stylesheet">
<link href="{% static "inspinia/js/plugins/toastr/toastr.min.css" %}" rel="stylesheet">
{%endblock css%}

{% block content %}
  <div id="page-wrapper" class="gray-bg">
    {% include 'destinations/navbar_top.html' %}

    <div class="wrapper wrapper-content animated fadeInRight">
      <div class="p-w-md m-t-sm">
        <div class="row">

            <div class="ibox">
              <div class="ibox-content">
                <div class="row">
                  <form id="form-itinerary">
                  {% csrf_token %}
                  <div class="col-md-12">
                    <div class="form-group">
                        <label class="font-normal">{% trans "Destiny"%}</label>
                        <select data-placeholder="{% trans "Choose a Destiny..."%}" class="chosen-select" name="destination" id="select_destiny" tabindex="2" style ="width:100%" required="required">
                        </select>
                    </div>

                      <div class="ibox b-r-md collapsed panel-success ml-0 mr-0 pl-0 pr-0">
                        <div class="ibox-title panel-heading collapse-link">
                            <h5 class="text-center">{% trans "Create new Itinerary"%} ({% trans "Clic Here"%})</h5>
                            <div class="ibox-tools">
                                <a class="collapse-link">
                                    <i class="fa fa-chevron-up"></i>
                                </a>
                            </div>
                        </div>
                        <div class="ibox-content">
                          <div class="row">
                            <div class="col-md-12">
                              <div class="form-group">
                                <label class="font-normal">
                                  {{form.short_description.label}}
                                </label>
                                {{form.short_description}}
                              </div>
                            </div>
                            <div class="col-md-12">
                              <div class="form-group">
                                <label class="font-normal">
                                  {{form.detail_itinerary.label}}
                                </label>
                                {{form.detail_itinerary|safe}}
                              </div>
                            </div>
                          </div>
                          <div class="col-md-12 text-center">
                            <button class="btn btn-success" type="submit">{% trans "Create a new itinerary"%}</button>
                          </div>
                        </div>
                        </div>

                  </div>
                  </form>
                  <div class="col-md-12 mt-4">
                    <div class="table-responsive">
                      <table id ="table-itinerary" class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th data-filter="false">#</th>
                                <th>{% trans "Destination's name"%}</th>
                                <th>{% trans "Short Title"%}</th>
                                <th>{% trans "Itinerary Description"%}</th>
                                <th data-filter="false"></th>
                            </tr>
                        </thead>
                        <tbody>                       
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>               
              </div>

          </div>
          {% include 'destinations/modal.html' %}
        </div>
      </div>
    </div>
    {% include 'destinations/footer.html' %}
  </div>
{% endblock %}


{% block js %}
  {{ block.super }}
  {{ form.media.js }}
  <script src="{% static "inspinia/js/plugins/dataTables/datatables.min.js" %}"></script>
  <script src="{% static "inspinia/js/plugins/dataTables/dataTables.bootstrap4.min.js"%}"></script>
  <script src="{% static "inspinia/js/plugins/select2/select2.full.min.js" %}"></script>
  <script src="{% static "inspinia/js/plugins/toastr/toastr.min.js" %}"></script>
  <script src="{% static "inspinia/js/notifications.js" %}"></script>
  <script>

    $(document).ready(function(){
        $('#table-itinerary thead tr').clone(true).appendTo( '#table-itinerary thead' );
        $('#table-itinerary thead tr:eq(1) th').each( function (i) {
            var title = $(this).text();
            if ($(this).data('filter') != false ){
                if ($(this).data('type')=='number'){
                    $(this).html( '<input class="form-control" type="number" placeholder="Busca '+title+'" />' );
                }else{
                    $(this).html( '<input class="form-control" type="text" placeholder="Busca '+title+'" />' );
                }
            }

            $( 'input', this ).on( 'keyup change', function () {
                if ( table_itinerary.column(i).search() !== this.value ) {
                    table_itinerary
                        .column(i)
                        .search( this.value )
                        .draw();
                }
            });
        });

        var table_itinerary=$('#table-itinerary').DataTable({
            pageLength: 10,
            responsive: true,
            fixedHeader: true,
            ajax: {
              processing: false,
              url: '{% url 'destinations:get-itinerary' %}',
              'dataSrc':'',
            },
            columns: [
              { data: 'fields.counter', name: 'fields.counter' },
              { data: null, 'render': function(data, type, full, meta)
                {
                  return data.fields.destination
                }
              },
              { data: null, 'render': function(data, type, full, meta)
                {
                return data.fields.short_title
                }
              },
              { data: null, 'render': function(data, type, full, meta)
                {
                return data.fields.content
                }
              },
              { data: null, 'render': function(data, type, full, meta)
                {
                  var buttons;
                  buttons = '<span><i onClick="delete_itinerary('+data.fields.id+')" class="fa fa-lg fa-trash mr-10"></i></span>' 
                  buttons += '<span><i onClick="update_itinerary('+data.fields.id+')" class="fa fa-lg fa-edit mr-10"></i></span>' 
                  return buttons; 
                }
              }
            ]
            
        });

        $("#select_destiny").select2({
          placeholder: "{% trans 'Select a destiny' %}",
           ajax: {
                  url: "{% url 'destinations:get-itinerary' %}",
                  dataType: "json",
                  delay: 250,
                  data: function (params) {
                      return {
                          q: (params.term) ? params.term : "", // search term
                          page: params.page || 1
                      };
                  },
                  processResults: function (response) {
                      return {
                         results: response
                      };
                  },
                  cache: true
              },
              minimumInputLength: 0,
        }
        ).on('select2:select', function (e) {
          table_itinerary.ajax.url("{% url 'destinations:get-itinerary' %}?destiny="+e.params.data.id).load()
        }); 

        $("#form-itinerary").submit(function( event ) {
          event.preventDefault();
          $.ajax({
            url: '{% url 'destinations:add-itinerary' %}',
            type: 'POST',
            dataType: 'json',
            data: $(this).serialize(),
          })
          .done(function(request) {
            if(request.status ==false){
              notificationErrorFormLabels(request.error)
            }else{
              notification('success',request.msg)
              $("#form-itinerary")[0].reset();
              $("#id_detail_itinerary").summernote("reset")
              table_itinerary.ajax.url("{% url 'destinations:get-itinerary' %}?destiny="+$("#select_destiny").val()).load()
            }
          })
          .fail(function() {
            console.log("error");
          })
        });

    });
    </script>
  <script type="text/javascript" src="{% static 'destinations/js/modal.js' %}"></script>
  <script>initSummernote();</script>
{% endblock %}